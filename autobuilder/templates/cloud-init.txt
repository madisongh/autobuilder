#cloud-config
bootcmd:
    - [ sh, -c, "[ -e /dev/$(lsblk -ndoNAME,MODEL | grep 'Instance Storage' | awk '{print $1}' | head -n1)p1 ] || sgdisk /dev/$(lsblk -ndoNAME,MODEL | grep 'Instance Storage' | awk '{print $1}' | head -n1) --largest-new=0 --typecode=0:8300 && partprobe" ]
    - [ sh, -c, "[ -e /dev/disk/by-label/SCRATCH ] || mkfs.ext4 -q -F -L SCRATCH -E nodiscard,lazy_itable_init  /dev/$(lsblk -ndoNAME,MODEL | grep 'Instance Storage' | awk '{print $1}' | head -n1)p1" ]

mounts:
    - [ "LABEL=SCRATCH", "/scratch", "auto", "defaults,noatime,nodiratime,nofail,nosuid,nodev,x-systemd.requires=cloud-init.service", "0", "2" ]

package_update: true
package_upgrade: true

packages:
    - build-essential
    - chrpath
    - socat
    - cpio
    - gawk
    - wget
    - git-core
    - diffstat
    - unzip
    - texinfo
    - gcc-multilib
    - python
    - python3
    - python3-pip
    - python3-pexpect
    - xz-utils
    - debianutils
    - iputils-ping
    - python3-git
    - python3-jinja2
    - libegl1-mesa
    - libsdl1.2-dev
    - pylint3
    - xterm
    - emacs
    - curl
    {% for pkg in extra_packages %}
    - {{ pkg }}
    {% endfor %}

users:
    - default
    - name: builder
      gecos: Auto Builder
      lock_passwd: true
      uid: "2000"
      shell: /bin/bash

write_files:
    - content: |
        WORKERNAME="{{ workername }}"
        WORKERSECRET="{{ workersecret }}"
        MASTER="{{ master_ip }}"
      path: /run/buildworker/settings
      permissions: '0600'
    - content: |
        {{ master_ip }} {{ master_hostname }} {{ master_fqdn }}
      path: /etc/hosts
      append: true

runcmd:
    - python3 -m pip install awscli
    - python3 -m pip install boto3
    - python3 -m pip install buildbot-worker
    - python3 -m pip install https://github.com/madisongh/buildworker-scripts/releases/download/v0.1.0-pre2/buildworker_scripts-0.1.0-py3-none-any.whl
    - python3 -m pip install https://github.com/madisongh/git-credential-aws-secrets/releases/download/v0.0.2/git_credential_aws_secrets-0.0.2-py3-none-any.whl
    - mkdir /var/lib/bwsetup
    - [ sh, -c, "curl -L https://github.com/madisongh/buildworker-setup/releases/download/v0.1.0-pre3/buildworker-setup-0.1.0.tar.gz | tar -C /var/lib/bwsetup -x -z -f-" ]
    - [ sh, -c, "cd /var/lib/bwsetup/buildworker-setup-0.1.0; ./configure --prefix=/usr && make && make install" ]
    - systemctl enable buildworker-setup.service
    - systemctl enable buildworker.service
    - systemctl start buildworker-setup
    {% for cmd in extra_cmds %}
    - {{ cmd }}
    {% endfor %}
    - systemctl start buildworker
